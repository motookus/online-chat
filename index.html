<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆï¼ˆç®¡ç†è€…ä»˜ãï¼‰</title>
  <style>
    body { font-family: sans-serif; }
    #chat { border:1px solid #aaa; height:200px; overflow-y:auto; padding:5px; }
    #users { border:1px solid #aaa; height:150px; overflow-y:auto; padding:5px; margin-top:5px; }
    .admin { color:red; font-weight:bold; }
    .user { color:black; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const discord = new Audio("notification.mp3");
    
    // === Firebaseè¨­å®š ===
    const firebaseConfig = {
      databaseURL: "https://speak-598d0-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === ãƒ¦ãƒ‹ãƒ¼ã‚¯IDï¼ˆå›ºå®šåŒ–ï¼‰ ===
    let myId = localStorage.getItem("myId");
    if (!myId) {
      myId = "id-" + Math.random().toString(36).slice(2,10);
      localStorage.setItem("myId", myId);
    }

    // === å‚ç…§ ===
    const usersRef = ref(db, "users");
    const chatRef = ref(db, "chat");
    const banRef = ref(db, "banned");
    const kickRef = ref(db, "kicked");

    const userRef = uid => ref(db, "users/" + uid);
    const bannedUserRef = uid => ref(db, "banned/" + uid);
    const kickedUserRef = uid => ref(db, "kicked/" + uid);

async function renderBlacklist() {
  const bannedSnap = await get(ref(db, "banned"));
  const bannedData = bannedSnap.val() || {};
  const ul = document.getElementById("blacklistDisplay");
  ul.innerHTML = "";

  const usersSnap = await get(usersRef);
  const users = usersSnap.val() || {};

  for (const uid in bannedData) {
    const name = users[uid]?.name || "åç„¡ã—";
    const li = document.createElement("li");
    li.textContent = name;

    if (isAdmin) {
      const btn = document.createElement("button");
      btn.textContent = "è§£é™¤";
      btn.onclick = () => remove(ref(db, "banned/" + uid));
      li.appendChild(btn);
    }
    ul.appendChild(li);
  }
}

// åˆæœŸæç”»
renderBlacklist();

// ç›£è¦–ã—ã¦æ›´æ–°
onValue(ref(db, "banned"), renderBlacklist);

    
    // === ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ ===
    const ADMIN_CODE = "12480851548902103219856012019984997110646402160464684614897894056406480098774054016199403201689798750131065656";
    let isAdmin = false;

    // === UIè¦ç´  ===
    const chatBox = document.getElementById("chat");
    const usersBox = document.getElementById("users");

    // === ãƒšãƒ¼ã‚¸é–‹ã„ãŸæ™‚ã«åç„¡ã—ã§ç™»éŒ² ===
    (async () => {
      const snap = await get(userRef(myId));
      if (!snap.exists()) {
        await set(userRef(myId), { name: "åç„¡ã—" });
      }
    })();

    // === åå‰æ±ºå®š ===
    document.getElementById("setNameBtn").onclick = async () => {
      let name = document.getElementById("nameInput").value.trim();
      if (!name) name = "åç„¡ã—";
      await set(userRef(myId), { name });
    };

// ç®¡ç†è€…ã«ãªã£ãŸæ™‚ã«æç”»
document.getElementById("setAdminBtn").onclick = () => {
  const code = document.getElementById("adminCode").value.trim();
  if (code === ADMIN_CODE) {
    isAdmin = true;
    alert("ç®¡ç†è€…æ¨©é™ã‚’å–å¾—ã—ã¾ã—ãŸ");
    document.getElementById("hideOnlineBtn").style.display = "inline-block";
    renderBlacklist();
  } else {
    alert("ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }
};

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
onValue(ref(db, "banned"), () => {
  if (isAdmin) renderBlacklist();
});



    // === ãƒãƒ£ãƒƒãƒˆé€ä¿¡ ===
    document.getElementById("sendBtn").onclick = async () => {
      const msg = document.getElementById("msgInput").value.trim();
      if (!msg) return;
      const snap = await get(userRef(myId));
              discord.play()
      const name = snap.val()?.name || "åç„¡ã—";
      await push(chatRef, { uid: myId, name, text: msg, time: Date.now() });
      document.getElementById("msgInput").value = "";
    };

    // === ãƒãƒ£ãƒƒãƒˆå‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ ===
    document.getElementById("clearChatBtn").onclick = async () => {
      if (!isAdmin) return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
      await remove(chatRef);
    };

    // === BANå‡¦ç† ===
    document.getElementById("banBtn").onclick = async () => {
      if (!isAdmin) return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await set(bannedUserRef(uid), true);
          alert(target + " ã‚’BANã—ã¾ã—ãŸ");
        }
      }
    };

    // === Unbanå‡¦ç† ===
    document.getElementById("unbanBtn").onclick = async () => {
      if (!isAdmin) return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await remove(bannedUserRef(uid));
          alert(target + " ã®BANã‚’è§£é™¤ã—ã¾ã—ãŸ");
        }
      }
    };

    // === Kickå‡¦ç† ===
    document.getElementById("kickBtn").onclick = async () => {
      if (!isAdmin) return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await set(kickedUserRef(uid), { by: myId, ts: Date.now() });
          alert(target + " ã‚’Kickã—ã¾ã—ãŸ");
        }
      }
    };

    // === ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º ===
    onValue(chatRef, snap => {
      chatBox.innerHTML = "";
      const msgs = snap.val() || {};
      for (const key in msgs) {
        const m = msgs[key];
        const time = new Date(m.time).toLocaleTimeString();
        let cls = "user";
        if (isAdmin && m.uid === myId) cls = "admin";
        chatBox.innerHTML += `<div class="${cls}">[${time}] ${m.name}: ${m.text}</div>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    });

let hiddenOnline = false;

document.getElementById("hideOnlineBtn").onclick = () => {
  hiddenOnline = !hiddenOnline;
  document.getElementById("hideOnlineBtn").textContent = hiddenOnline ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º" : "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚’éš ã™";

  // è‡ªåˆ†ã ã‘ usersBox ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«å†æç”»
  onValue(usersRef, snap => {
    usersBox.innerHTML = "";
    const users = snap.val() || {};
    for (const uid in users) {
      if (uid === myId && hiddenOnline) continue; // è‡ªåˆ†ã‚’éè¡¨ç¤º
      const u = users[uid];
      const role = (isAdmin && uid === myId) ? "ğŸ‘‘" : "ğŸ‘¤";
      const cls = (isAdmin && uid === myId) ? "admin" : "user";
      usersBox.innerHTML += `<div class="${cls}">${role} ${u.name}</div>`;
    }
  });
};


    // === BANç›£è¦– ===
    onValue(bannedUserRef(myId), snap => {
      if (snap.exists()) {
        alert("BANã•ã‚Œã¾ã—ãŸã€‚å†å…¥å®¤ã§ãã¾ã›ã‚“ã€‚");
        document.body.innerHTML = "<h1>ã‚ãªãŸã¯BANã•ã‚Œã¾ã—ãŸ</h1>";
      }
    });

    // === Kickç›£è¦– ===
    onValue(kickedUserRef(myId), snap => {
      if (snap.exists()) {
        alert("Kickã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸå†æ¥ç¶šã—ã¦ãã ã•ã„ã€‚");
        document.body.innerHTML = "<h1>Kickã•ã‚Œã¾ã—ãŸ</h1>";
        // Kickã¯ä¸€æ™‚çš„ â†’ ã™ãå‰Šé™¤ã—ã¦å†å…¥ã‚Œã‚‹ä½™åœ°ã‚’æ®‹ã™
        setTimeout(() => remove(kickedUserRef(myId)), 10000);
      }
    });

// ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç›£è¦–
onValue(ref(db, "banned"), snap => {
  const bannedData = snap.val() || {};
  const ul = document.getElementById("blacklistDisplay");
  ul.innerHTML = "";

  // users ãƒãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ UID â†’ åå‰ãƒãƒƒãƒ—ä½œæˆ
  get(usersRef).then(usersSnap => {
    const users = usersSnap.val() || {};
    for (const uid in bannedData) {
      const name = users[uid]?.name || "åç„¡ã—";
      const li = document.createElement("li");
      li.textContent = name;

      // ç®¡ç†è€…ãªã‚‰è§£é™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (isAdmin) {
        const btn = document.createElement("button");
        btn.textContent = "è§£é™¤";
        btn.onclick = () => remove(ref(db, "banned/" + uid));
        li.appendChild(btn);
      }
      ul.appendChild(li);
    }
  });
});

    
    // === ãƒšãƒ¼ã‚¸é–‰ã˜ãŸã‚‰é€€å®¤ ===
    window.addEventListener("beforeunload", () => {
      remove(userRef(myId));
    });
  </script>
</head>
<body>
  <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆï¼ˆç®¡ç†è€…ä»˜ãï¼‰</h2>
  åå‰: <input id="nameInput"><button id="setNameBtn">åå‰ã‚’æ±ºå®š</button><br>
  ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰: <input id="adminCode"><button id="setAdminBtn">ç®¡ç†è€…ã«ãªã‚‹</button><br>
  <div id="users"></div>
  <div id="chat"></div>
  <input id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"><button id="sendBtn">é€ä¿¡</button>
  <button id="clearChatBtn">ãƒãƒ£ãƒƒãƒˆå‰Šé™¤</button>
  <br><br>
  å¯¾è±¡å: <input id="targetName">
  <button id="banBtn">Ban</button>
  <button id="unbanBtn">Unban</button>
  <button id="kickBtn">Kick</button>
<div>
  <h3>ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
  <ul id="blacklistDisplay"></ul>  <!-- ã“ã“ã‚’è¿½åŠ  -->
</div>
  <button id="hideOnlineBtn" style="display:none;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚’éš ã™</button>
</body>
</html>
