<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>オンラインチャット（管理者付き）</title>
  <style>
    body { font-family: sans-serif; }
    #chat { border:1px solid #aaa; height:200px; overflow-y:auto; padding:5px; }
    #users { border:1px solid #aaa; height:150px; overflow-y:auto; padding:5px; margin-top:5px; }
    .admin { color:red; font-weight:bold; }
    .user { color:black; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const discord = new Audio("notification.mp3");
    
    // === Firebase設定 ===
    const firebaseConfig = {
      databaseURL: "https://speak-598d0-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === ユニークID（固定化） ===
    let myId = localStorage.getItem("myId");
    if (!myId) {
      myId = "id-" + Math.random().toString(36).slice(2,10);
      localStorage.setItem("myId", myId);
    }

    // === 参照 ===
    const usersRef = ref(db, "users");
    const chatRef = ref(db, "chat");
    const banRef = ref(db, "banned");
    const kickRef = ref(db, "kicked");

    const userRef = uid => ref(db, "users/" + uid);
    const bannedUserRef = uid => ref(db, "banned/" + uid);
    const kickedUserRef = uid => ref(db, "kicked/" + uid);

async function renderBlacklist() {
  const bannedSnap = await get(ref(db, "banned"));
  const bannedData = bannedSnap.val() || {};
  const ul = document.getElementById("blacklistDisplay");
  ul.innerHTML = "";

  const usersSnap = await get(usersRef);
  const users = usersSnap.val() || {};

  for (const uid in bannedData) {
    const name = users[uid]?.name || "名無し";
    const li = document.createElement("li");
    li.textContent = name;

    if (isAdmin) {
      const btn = document.createElement("button");
      btn.textContent = "解除";
      btn.onclick = () => remove(ref(db, "banned/" + uid));
      li.appendChild(btn);
    }
    ul.appendChild(li);
  }
}

// 初期描画
renderBlacklist();

// 監視して更新
onValue(ref(db, "banned"), renderBlacklist);

    
    // === 管理者コード ===
    const ADMIN_CODE = "12480851548902103219856012019984997110646402160464684614897894056406480098774054016199403201689798750131065656";
    let isAdmin = false;

    // === UI要素 ===
    const chatBox = document.getElementById("chat");
    const usersBox = document.getElementById("users");

    // === ページ開いた時に名無しで登録 ===
    (async () => {
      const snap = await get(userRef(myId));
      if (!snap.exists()) {
        await set(userRef(myId), { name: "名無し" });
      }
    })();

    // === 名前決定 ===
    document.getElementById("setNameBtn").onclick = async () => {
      let name = document.getElementById("nameInput").value.trim();
      if (!name) name = "名無し";
      await set(userRef(myId), { name });
    };

// 管理者になった時に描画
document.getElementById("setAdminBtn").onclick = () => {
  const code = document.getElementById("adminCode").value.trim();
  if (code === ADMIN_CODE) {
    isAdmin = true;
    alert("管理者権限を取得しました");
    document.getElementById("hideOnlineBtn").style.display = "inline-block";
    renderBlacklist();
  } else {
    alert("管理者コードが違います");
  }
};

// リアルタイム更新
onValue(ref(db, "banned"), () => {
  if (isAdmin) renderBlacklist();
});



    // === チャット送信 ===
    document.getElementById("sendBtn").onclick = async () => {
      const msg = document.getElementById("msgInput").value.trim();
      if (!msg) return;
      const snap = await get(userRef(myId));
              discord.play()
      const name = snap.val()?.name || "名無し";
      await push(chatRef, { uid: myId, name, text: msg, time: Date.now() });
      document.getElementById("msgInput").value = "";
    };

    // === チャット削除（管理者のみ） ===
    document.getElementById("clearChatBtn").onclick = async () => {
      if (!isAdmin) return alert("権限がありません");
      await remove(chatRef);
    };

    // === BAN処理 ===
    document.getElementById("banBtn").onclick = async () => {
      if (!isAdmin) return alert("権限がありません");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await set(bannedUserRef(uid), true);
          alert(target + " をBANしました");
        }
      }
    };

    // === Unban処理 ===
    document.getElementById("unbanBtn").onclick = async () => {
      if (!isAdmin) return alert("権限がありません");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await remove(bannedUserRef(uid));
          alert(target + " のBANを解除しました");
        }
      }
    };

    // === Kick処理 ===
    document.getElementById("kickBtn").onclick = async () => {
      if (!isAdmin) return alert("権限がありません");
      const target = document.getElementById("targetName").value.trim();
      if (!target) return;
      const snap = await get(usersRef);
      const users = snap.val() || {};
      for (const uid in users) {
        if (users[uid].name === target) {
          await set(kickedUserRef(uid), { by: myId, ts: Date.now() });
          alert(target + " をKickしました");
        }
      }
    };

    // === チャット表示 ===
    onValue(chatRef, snap => {
      chatBox.innerHTML = "";
      const msgs = snap.val() || {};
      for (const key in msgs) {
        const m = msgs[key];
        const time = new Date(m.time).toLocaleTimeString();
        let cls = "user";
        if (isAdmin && m.uid === myId) cls = "admin";
        chatBox.innerHTML += `<div class="${cls}">[${time}] ${m.name}: ${m.text}</div>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    });

let hiddenOnline = false;

document.getElementById("hideOnlineBtn").onclick = () => {
  hiddenOnline = !hiddenOnline;
  document.getElementById("hideOnlineBtn").textContent = hiddenOnline ? "オンラインを表示" : "オンラインを隠す";

  // 自分だけ usersBox に表示されないように再描画
  onValue(usersRef, snap => {
    usersBox.innerHTML = "";
    const users = snap.val() || {};
    for (const uid in users) {
      if (uid === myId && hiddenOnline) continue; // 自分を非表示
      const u = users[uid];
      const role = (isAdmin && uid === myId) ? "👑" : "👤";
      const cls = (isAdmin && uid === myId) ? "admin" : "user";
      usersBox.innerHTML += `<div class="${cls}">${role} ${u.name}</div>`;
    }
  });
};


    // === BAN監視 ===
    onValue(bannedUserRef(myId), snap => {
      if (snap.exists()) {
        alert("BANされました。再入室できません。");
        document.body.innerHTML = "<h1>あなたはBANされました</h1>";
      }
    });

    // === Kick監視 ===
    onValue(kickedUserRef(myId), snap => {
      if (snap.exists()) {
        alert("Kickされました。また再接続してください。");
        document.body.innerHTML = "<h1>Kickされました</h1>";
        // Kickは一時的 → すぐ削除して再入れる余地を残す
        setTimeout(() => remove(kickedUserRef(myId)), 10000);
      }
    });

// ブラックリストを監視
onValue(ref(db, "banned"), snap => {
  const bannedData = snap.val() || {};
  const ul = document.getElementById("blacklistDisplay");
  ul.innerHTML = "";

  // users ノードを取得して UID → 名前マップ作成
  get(usersRef).then(usersSnap => {
    const users = usersSnap.val() || {};
    for (const uid in bannedData) {
      const name = users[uid]?.name || "名無し";
      const li = document.createElement("li");
      li.textContent = name;

      // 管理者なら解除ボタンを追加
      if (isAdmin) {
        const btn = document.createElement("button");
        btn.textContent = "解除";
        btn.onclick = () => remove(ref(db, "banned/" + uid));
        li.appendChild(btn);
      }
      ul.appendChild(li);
    }
  });
});

    
    // === ページ閉じたら退室 ===
    window.addEventListener("beforeunload", () => {
      remove(userRef(myId));
    });
  </script>
</head>
<body>
  <h2>オンラインチャット（管理者付き）</h2>
  名前: <input id="nameInput"><button id="setNameBtn">名前を決定</button><br>
  管理者コード: <input id="adminCode"><button id="setAdminBtn">管理者になる</button><br>
  <div id="users"></div>
  <div id="chat"></div>
  <input id="msgInput" placeholder="メッセージを入力"><button id="sendBtn">送信</button>
  <button id="clearChatBtn">チャット削除</button>
  <br><br>
  対象名: <input id="targetName">
  <button id="banBtn">Ban</button>
  <button id="unbanBtn">Unban</button>
  <button id="kickBtn">Kick</button>
<div>
  <h3>ブラックリスト</h3>
  <ul id="blacklistDisplay"></ul>  <!-- ここを追加 -->
</div>
  <button id="hideOnlineBtn" style="display:none;">オンラインを隠す</button>
</body>
</html>
